<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>nofraud! v3.4</title>
<style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f8f9fa;
      color: #000;
      transition: background-color 0.3s, color 0.3s;
    }
    #navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: rgba(0,0,0,0.6);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      z-index: 10;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      background-color: mediumaquamarine;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #3c7e68;
      transition: 0.5s;
    }
    #fileInput {
    padding: 10px;
    margin-bottom: 20px;
    }
    #logo {
      height: 32px;
    }
    #title {
      display: flex;
      align-items: center;
    }
    #menu-icon {
      font-size: 28px;
      cursor: pointer;
    }
    #sideMenu {
      position: fixed;
      top: 60px;
      right: 20px;
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      width: 260px;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 20;
    }
    #sideMenu.show {
      display: block;
    }
    .dark-mode #sideMenu {
      background-color: #222;
      color: white;
      border-color: #444;
    }
    .switch {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .switch input {
      display: none;
    }
    .slider {
      width: 40px;
      height: 20px;
      background-color: #ccc;
      border-radius: 20px;
      margin-right: 10px;
      position: relative;
    }
    .slider:before {
      content: "";
      position: absolute;
      left: 2px;
      top: 2px;
      width: 16px;
      height: 16px;
      background-color: white;
      border-radius: 50%;
      transition: 0.3s;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
      background-color: #222;
    }
    .dark-mode {
      background-color: #121212;
      color: white;
    }
    .dark-mode table {
      background-color: #1e1e1e;
      color: white;
    }
    .chart {
      width: 80%;
      margin: 40px auto 20px auto;
      text-align: center;
    }
    .chart img {
      display: block;
      margin: 0 auto;
    }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
    }
    tr.fraud {
      background-color: #ffdddd;
      color: black;
    }
    .dark-mode tr.fraud {
      background-color: #ffdddd;
      color: black;
    }
    #result {
      text-align: center;
      font-size: 18px;
      margin-top: 20px;
    }
@property --loader_l0{
  syntax: "<percentage>";
  initial-value: 0%;
  inherits: false;
}
@property --loader_l1{
  syntax: "<percentage>";
  initial-value: 0%;
  inherits: false;
}

.loader{
  /*Since it's gonna be circle, width and height are the same.*/
  --width:64px;
  position:absolute;
  left:calc(50% - calc(var(--width) / 2));
  top:calc(50% - calc(var(--width) / 2));
  perspective:1000px;
  z-index: 1000;
}
.loader.done {
  opacity: 0;
  transition: opacity 2s ease-in;
}
.loader-done{
  position:absolute;
  display:none;
  border-top:3px solid #7051c3;
  border-left:3px solid #7051c3;
  border-top-left-radius:3px;
  width:calc(var(--width) / 6);
  height:calc(var(--width) / 3);
  top:calc(var(--width) / 2 - 15px);
  left:calc(var(--width) / 2 - 7px);
  transform:rotateZ(220deg);
  animation:loaderFadeIn .6s;
  opacity: 0;
  transition: opacity 2s ease-in;
}
.circle{
  position:absolute;
  top:0;
  left:0;
  width:var(--width);
  height:var(--width);
  transform:rotateX(0deg) rotateY(0deg) rotateZ(0deg);
}
.circle::before {
  content: "";
  position: absolute;
  z-index: -1;
  inset: 0;
  padding: 3px;
  border-radius: 100%;
  background: linear-gradient(
    45deg,
    #a947f4 0%,
    #f24479 var(--loader_l0),
    #a947f4 var(--loader_l1), 
    #f24479 100%
  );
  -webkit-mask: 
     linear-gradient(#fff 0 0) content-box, 
     linear-gradient(#fff 0 0);
          mask: 
     linear-gradient(#fff 0 0) content-box, 
     linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;

}
.circle.c1{
  animation:rx 2s infinite, gradientMove 1s infinite;
}
.circle.c2{
  animation:ry 1s infinite, gradientMove .5s infinite;
}
.circle.c3{
  animation:rz 1.5s infinite, gradientMove .75s infinite;
}

.loader.done .circle.c1,
.loader.done .circle.c2,
.loader.done .circle.c3{
  animation:rfinal .5s;
}

.loader.done .loader-done{
  display:block;
}
.loader.hidden {
  display: none;
}

#overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.3); /* затемнение */
  z-index: 999; /* ниже loader */
}
#overlay.hidden {
  display: none;
}

@keyframes rx{
  from{
    
  }
  50%{
    opacity:.6;
  }
  100%{
    transform: rotateZ(360deg) rotateX(180deg);
  }
}

@keyframes ry{
  from{
    
  }
  60%{
    filter:blur(1px);
    opacity:.4;
  }
  100%{
    transform:rotateZ(180deg) rotateY(180deg);
  }
}

@keyframes rz{
  from{
    
  }
  40%{
    filter:blur(1px);
    opacity:.8;
  }
  100%{
     transform:rotateZ(180deg) rotateY(-180deg);
  }
}

@keyframes loaderFadeIn{
  0%{opacity:0;}
  100%{opacity:1;}
}

@keyframes gradientMove{
  0%{
    --button_b:0%;
    --button_b_out:0%;
  }
  33%{
    --button_b:100%;
    --button_b_out:0%;
  }
  99%{
    --button_b:100%;
    --button_b_out:100%;
  }
  100%{
    --button_b:0%;
    --button_b_out:0%;
  }
}
  
#logContainer {
  display: none;
  position: fixed;
  bottom: 0;
  left: 10px;
  right: 10px;
  max-height: 200px;
  background-color: #111;
  color: #0f0;
  font-family: monospace;
  font-size: 12px;
  overflow-y: auto;
  padding: 10px;
  border-radius: 10px 10px 0 0;
  z-index: 100;
}

div#instructionBox {
    color: black;
}

div#welcomeBox {
    color: black;
}

h2 {
    color: black;
}

button#button_train_model {
    background-color: hotpink;
}
</style>
</head>
<body>
  <div id="navbar">
    <div id="title">
      <img src="logo_nofraud.png" id="logo">
    </div>
    <div id="menu-icon" onclick="toggleMenu()">☰</div>
  </div>

  <div id="sideMenu" class="hidden">
    <!-- Переключатели -->
  </div>

  <div style="text-align: center; margin-top: 100px;">
    <h1 style="font-size: 36px;">nofraud! v3.4</h1>
    <div style="margin: 10px;">
      <label for="modelSelect"><strong>Выбор модели:</strong></label>
      <select id="modelSelect">
        <option value="test">TEST (предобученная)</option>
        <option value="new">NEW (пользовательская)</option>
      </select>
    </div>
    <input type="file" id="fileInput"><br>
    <button onclick="uploadFile()">Проверить</button>
    <br>
    <input type="file" id="trainFile" style="margin-top:50px;">
    <br>
    <button onclick="trainModel()" id="button_train_model">Обучить!</button>
    <br>
    <button id="downloadCsv" style="display:none;">Скачать CSV</button>
    <button id="downloadPdf" style="display:none;">Скачать PDF</button>
    <div id="overlay" class="hidden"></div>
    <div class="loader hidden" id="loader">
      <span class="loader-done"></span>
      <span class="circle c1"></span>
      <span class="circle c2"></span>
      <span class="circle c3"></span>
    </div>
    <div id="result"></div>
    <div id="previewTable"></div>
    <!-- Блоки приветствия и инструкции -->
  </div>

  <div class="chart">
    <img id="chart1" src="" style="max-width:100%; display:none;">
    <p id="chart1-desc" style="display:none;">Этот график отображает распределение сумм всех выявленных мошеннических транзакций...</p>
  </div>
  <div class="chart">
    <img id="chart2" src="" style="max-width:100%; display:none;">
    <p id="chart2-desc" style="display:none;">Этот график показывает, в какие часы суток чаще всего происходят мошеннические транзакции...</p>
  </div>

<script>
const API_URL = 'https://awake-comfort-production.up.railway.app';

function toggleMenu() {
  document.getElementById("sideMenu").classList.toggle("show");
}
function toggleDarkMode() {
  document.body.classList.toggle("dark-mode");
}

let csvReady = false;
function uploadFile() {
  const input = document.getElementById('fileInput');
  if (!input.files[0]) {
    alert("Пожалуйста, выберите CSV-файл перед проверкой.");
    return;
  }
  const loader = document.querySelector('.loader');
  loader.style.display = 'block';
  loader.classList.remove('done');
  const tableContainer = document.getElementById('previewTable');
  const chart1 = document.getElementById('chart1');
  const chart2 = document.getElementById('chart2');
  const data = new FormData();
  data.append('file', input.files[0]);
  const modelType = document.getElementById('modelSelect').value;
  data.append('modelType', modelType);
  document.getElementById('overlay').classList.remove('hidden');

  fetch(`${API_URL}/upload`, { method: 'POST', body: data })
  .then(response => response.json())
  .then(data => {
    loader.classList.add('done');
    setTimeout(() => {
      loader.style.display = 'none';
      document.getElementById('overlay').classList.add('hidden');
      if (data.error) {
        alert("Ошибка от сервера: " + data.error);
        return;
      }
      const table = document.createElement('table');
      const headerRow = document.createElement('tr');
      data.columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);
      data.rows.forEach(row => {
        const tr = document.createElement('tr');
        if (row[row.length - 2] === 1) tr.classList.add('fraud');
        row.forEach(cell => {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
      tableContainer.innerHTML = '';
      tableContainer.appendChild(table);
      chart1.src = `${API_URL}/static/fraud_amount.png`;
      chart2.src = `${API_URL}/static/fraud_by_hour.png`;
      chart1.style.display = 'block';
      chart2.style.display = 'block';
      document.getElementById("chart1-desc").style.display = 'block';
      document.getElementById("chart2-desc").style.display = 'block';
      document.getElementById("downloadCsv").style.display = 'inline';
      document.getElementById("downloadPdf").style.display = 'inline';
      csvReady = true;
    }, 2000);
  })
  .catch(() => {
    loader.style.display = 'none';
    alert("❌ Ошибка при анализе файла.");
  });
}

document.getElementById('downloadCsv').onclick = function() {
  if (!csvReady) return;
  window.open(`${API_URL}/download`, '_blank');
};
document.getElementById('downloadPdf').onclick = function() {
  if (!csvReady) return;
  window.open(`${API_URL}/report`, '_blank');
};

function trainModel() {
  const trainInput = document.getElementById('trainFile');
  if (!trainInput.files[0]) {
    alert("Пожалуйста, выберите обучающий файл CSV.");
    return;
  }
  const data = new FormData();
  data.append('file', trainInput.files[0]);
  fetch(`${API_URL}/train`, { method: 'POST', body: data })
  .then(res => res.json())
  .then(resp => { alert(resp.message || "Обучение завершено."); })
  .catch(() => { alert("Ошибка при обучении модели."); });
}

window.onload = function () {
  if (localStorage.getItem("autoDark") === "true") {
    document.body.classList.add("dark-mode");
    document.getElementById("darkModeToggle").checked = true;
    document.getElementById("autoDarkToggle").checked = true;
  } else {
    document.getElementById("autoDarkToggle").checked = false;
  }
};
</script>

<div id="authOverlay" style="position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:1000; display:flex; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:8px; box-shadow:0 0 20px black; text-align:center;">
    <h2>Авторизация</h2>
    <input id="login" placeholder="Логин" style="margin:10px; padding:8px;"><br>
    <input id="password" placeholder="Пароль" type="password" style="margin:10px; padding:8px;"><br>
    <button onclick="authorize()">Войти</button>
    <p id="authError" style="color:red; display:none;">Неверный логин или пароль</p>
  </div>
</div>
<script>
function authorize() {
  const login = document.getElementById('login').value;
  const password = document.getElementById('password').value;
  if (login === 'ADMIN' && password === 'ADMIN') {
    document.getElementById('authOverlay').style.display = 'none';
  } else {
    document.getElementById('authError').style.display = 'block';
  }
}
</script>

<div id="logContainer"></div>

</body>
</html>
